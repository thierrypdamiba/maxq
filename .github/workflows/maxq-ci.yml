name: MaxQ CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  QDRANT_URL: ${{ secrets.QDRANT_URL }}
  QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}

jobs:
  eval:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Install dependencies
        run: uv sync
      
      # Step 1: Import data (skip if collection already exists)
      - name: Import data
        run: |
          uv run maxq import ${{ vars.DATASET_NAME || 'fka/awesome-chatgpt-prompts' }} \
            --collection ${{ vars.COLLECTION_NAME || 'ci-collection' }} \
            --limit 100
        continue-on-error: true  # May already exist
      
      # Step 2: Run evaluation
      - name: Run MaxQ evaluation
        run: |
          uv run maxq eval run \
            --collection ${{ vars.COLLECTION_NAME || 'ci-collection' }} \
            --eval ${{ vars.EVAL_PACK || 'default' }} \
            --preset ${{ vars.PRESET || 'mxbai_bm25' }} \
            --out runs/current.json
      
      # Step 3: CI gate against baseline
      - name: MaxQ CI gate
        id: ci
        run: |
          uv run maxq ci runs/current.json \
            --against baseline:${{ vars.BASELINE_NAME || 'main' }} \
            --max-ndcg-drop ${{ vars.MAX_NDCG_DROP || '-0.02' }} \
            --max-recall-drop ${{ vars.MAX_RECALL_DROP || '-0.05' }} \
            --output maxq_ci_report.md
      
      # Step 4: Upload report artifact
      - name: Upload MaxQ report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maxq-ci-report
          path: |
            maxq_ci_report.md
            runs/current.json
      
      # Step 5: Comment on PR (optional)
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('maxq_ci_report.md', 'utf8');
            } catch (e) {
              report = '## MaxQ CI Report\n\n:x: Failed to generate report. Check workflow logs.';
            }
            
            // Find existing MaxQ comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('MaxQ CI Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report,
              });
            }
