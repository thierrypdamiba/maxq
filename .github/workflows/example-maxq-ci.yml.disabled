# Example MaxQ CI workflow
# Copy this file to your project's .github/workflows/ directory

name: MaxQ Retrieval Tests

on:
  pull_request:
    paths:
      - 'src/**'
      - 'maxq.yaml'
      - '.github/workflows/example-maxq-ci.yml'
  push:
    branches: [main]

jobs:
  maxq-tests:
    name: Run MaxQ Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run MaxQ tests
        uses: thierrypdamiba/maxq-project/.github/actions/maxq-action@main
        with:
          config: maxq.yaml
          qdrant-url: ${{ secrets.QDRANT_URL }}
          qdrant-api-key: ${{ secrets.QDRANT_API_KEY }}
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}  # Optional
          fail-on-error: 'true'

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## MaxQ Test Results\n\n';

            try {
              const report = JSON.parse(fs.readFileSync('maxq_results.json', 'utf8'));
              const passed = report.passed ? '✅' : '❌';
              const summary = report.summary || {};

              comment += `| Status | Tests | Pass Rate |\n`;
              comment += `|--------|-------|----------|\n`;
              comment += `| ${passed} ${report.passed ? 'Passed' : 'Failed'} | ${summary.passed_tests}/${summary.total_tests} | ${(summary.pass_rate * 100).toFixed(1)}% |\n\n`;

              if (!report.passed && report.tests) {
                comment += '### Failed Tests\n\n';
                for (const test of report.tests.filter(t => !t.passed)) {
                  comment += `- ❌ **${test.query}**\n`;
                  for (const assertion of test.assertions.filter(a => !a.passed)) {
                    comment += `  - ${assertion.message}\n`;
                  }
                }
              }
            } catch (e) {
              comment += `⚠️ Could not parse test results: ${e.message}`;
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
